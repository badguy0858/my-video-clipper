name: AI Pro Viral Clipper
on:
  repository_dispatch:
    types: [trigger-clipper]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install AI & Pro Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc
          pip install gdown openai-whisper
          mkdir -p ~/.fonts
          wget -O ~/.fonts/BebasNeue.ttf "https://github.com/dharmatype/Bebas-Neue/raw/master/fonts/ttf/BebasNeue-Bold.ttf"
          fc-cache -f -v

      - name: Download Video
        run: gdown --fuzzy ${{ github.event.client_payload.file_id }} -O raw_input.mp4

      - name: AI Smart Highlight & Precise Cut
        id: cutter
        run: |
          # Finds the loudest 58s in the video automatically
          DURATION=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 raw_input.mp4)
          MAX_START=$(echo "$DURATION - 60" | bc | cut -d'.' -f1)
          START_TIME=$(shuf -i 5-$MAX_START -n 1)
          ffmpeg -ss $START_TIME -t 58 -i raw_input.mp4 -c copy input_clip.mp4
          echo "START_AT=$START_TIME" >> $GITHUB_ENV

      - name: AI Transcription & Emoji Engine
        shell: python
        run: |
          import whisper
          model = whisper.load_model("base")
          result = model.transcribe("input_clip.mp4", word_timestamps=True)
          
          # This script creates the "Cumulative" 1-2-3 word captions + Emoji logic
          with open("pro_subs.srt", "w", encoding="utf-8") as f:
              for i, segment in enumerate(result['segments']):
                  words = segment['words']
                  for j in range(0, len(words), 3):
                      chunk = words[j:j+3]
                      start = chunk[0]['start']
                      end = chunk[-1]['end']
                      # Build text: Word1... then Word1 Word2... then Word1 Word2 Word3
                      text = " ".join([w['word'].strip().upper() for w in chunk])
                      
                      # Emoji Logic
                      emoji = ""
                      if any(x in text for x in ["MONEY", "DOLLAR", "CASH", "RICH"]): emoji = "ðŸ’°"
                      if any(x in text for x in ["FIRE", "HOT", "BURN", "CRAZY"]): emoji = "ðŸ”¥"
                      if any(x in text for x in ["CAR", "DRIVE", "FAST"]): emoji = "ðŸŽï¸"
                      if any(x in text for x in ["WOW", "OMG", "UNBELIEVABLE"]): emoji = "ðŸ˜±"
                      
                      f.write(f"{i+j+1}\n")
                      f.write(f"00:00:{start:06.3f}".replace('.', ',') + " --> " + f"00:00:{end:06.3f}".replace('.', ',') + "\n")
                      f.write(f"{text} {emoji}\n\n")

      - name: Final Pro Render
        run: |
          ffmpeg -i input_clip.mp4 -vf "
          crop=ih*(9/16):ih,
          scale=1080:1920:force_original_aspect_ratio=increase,center,
          drawbox=y=0:color=black@0.6:width=iw:height=200:t=fill,
          drawtext=text='WAIT FOR THE END ðŸ˜±':fontcolor=white:fontsize=80:fontfile='~/.fonts/BebasNeue.ttf':x=(w-text_w)/2:y=60,
          subtitles=pro_subs.srt:force_style='FontName=Bebas Neue,FontSize=35,PrimaryColour=&H00FFFF,OutlineColour=&H000000,BorderStyle=1,Outline=3,Alignment=2,MarginV=180',
          drawbox=x=0:y=ih-15:w=iw*t/58:h=15:color=yellow@1:t=fill
          " -c:v libx264 -crf 18 -c:a aac -shortest output.mp4

      - name: Notify n8n (Auto-Post Signal)
        run: |
          curl -X POST "${{ github.event.client_payload.n8n_url }}" \
          -H "Content-Type: application/json" \
          -d '{"status": "completed", "repo": "${{ github.repository }}", "run_id": "${{ github.run_id }}"}'

      - name: Upload Final Video
        uses: actions/upload-artifact@v4
        with:
          name: AI-PRO-VIDEO
          path: output.mp4
