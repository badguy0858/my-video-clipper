name: AI Pro Animal Factory
on:
  repository_dispatch:
    types: [trigger-compilation]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install AI & Video Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc fonts-liberation
          pip install yt-dlp edge-tts openai-whisper

      - name: Download Bebas Neue Font
        run: |
          mkdir -p ~/.fonts
          wget -O ~/.fonts/BebasNeue.ttf "https://github.com/google/fonts/raw/main/ofl/bebasneue/BebasNeue-Regular.ttf" || true
          fc-cache -f -v

      - name: Scout & Download Reddit Videos
        # yt-dlp is much better at bypassing 403 errors than standard Python
        run: |
          mkdir clips
          yt-dlp "https://www.reddit.com/r/AnimalsBeingDerps/top/?t=day" \
          --flat-playlist --print url --limit-rate 5M --max-downloads 8 | head -n 5 > links.txt
          
          # If Reddit is totally blocked, fallback to searching YouTube for Reddit clips
          if [ ! -s links.txt ]; then
            echo "Reddit blocked, falling back to YouTube search..."
            yt-dlp "ytsearch5:funny animals reddit shorts" --flat-playlist --print url > links.txt
          fi
          
          yt-dlp -a links.txt -f "mp4" --no-playlist -o "clips/%(id)s.%(ext)s"

      - name: Generate AI Voiceover
        run: |
          edge-tts --text "These animals are having a totally normal day. Wait for the last one, it is hilarious! Subscribe for more fun." --write-media vo.mp3

      - name: Stitch Videos (Sync Fix)
        run: |
          mkdir processed
          # Standardize every clip to 1080x1920, 30fps, and clean audio
          for f in clips/*.mp4; do
            ffmpeg -y -i "$f" -vf "scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920,setsar=1,fps=30" -af "aresample=44100,pan=stereo|c0=c0|c1=c1" -c:v libx264 -preset superfast -an "processed/${f##*/}"
          done
          ls processed/*.mp4 | sed "s/^/file '/;s/$/'/" > list.txt
          # Create a silent version of the combined clips
          ffmpeg -f concat -safe 0 -i list.txt -c copy raw_stitch.mp4
          # Mix in the AI Voiceover
          ffmpeg -i raw_stitch.mp4 -i vo.mp3 -filter_complex "[1:a]adelay=500|500[voice];[0:a][voice]amix=inputs=2:duration=first" -c:v copy final_stitch.mp4

      - name: AI Klap Transcription (Pro Styling)
        shell: python
        run: |
          import whisper
          model = whisper.load_model("base")
          # Transcribe the STITCHED video so captions are perfectly synced
          result = model.transcribe("final_stitch.mp4", word_timestamps=True)
          
          with open("klap_subs.ass", "w", encoding="utf-8") as f:
              f.write("[Script Info]\nScriptType: v4.00+\nPlayResX: 1080\nPlayResY: 1920\n\n")
              f.write("[V4+ Styles]\nFormat: Name, Fontname, Fontsize, PrimaryColour, OutlineColour, BorderStyle, Outline, Alignment, MarginV\n")
              f.write(f"Style: Default,Bebas Neue,90,&H00FFFFFF,&H00000000,1,3,2,280\n\n")
              f.write("[Events]\nFormat: Layer, Start, End, Style, Text\n")
              
              for segment in result['segments']:
                  words = segment.get('words', [])
                  for i in range(len(words)):
                      start, end = words[i]['start'], words[i]['end']
                      window = words[i:min(i+3, len(words))]
                      line = []
                      for j, w in enumerate(window):
                          t = w['word'].strip().upper()
                          if j == 0: line.append(f"{{\\c&H0000FF00\\fscx120\\fscy120}}{t}{{\\r}}") # Pulse + Green Highlight
                          else: line.append(t)
                      ts = lambda s: f"{int(s//3600)}:{int((s%3600)//60):02d}:{s%60:05.2f}"
                      f.write(f"Dialogue: 0,{ts(start)},{ts(end)},Default,{' '.join(line)}\n")

      - name: Final Pro Render
        run: |
          ffmpeg -y -i final_stitch.mp4 -vf "ass=klap_subs.ass" -c:v libx264 -crf 18 -c:a aac -b:a 128k output.mp4

      - name: Post to YouTube
        shell: python
        env:
          ID: ${{ secrets.YT_CLIENT_ID }}
          SEC: ${{ secrets.YT_CLIENT_SECRET }}
          TOK: ${{ secrets.YT_REFRESH_TOKEN }}
        run: |
          import os
          from googleapiclient.discovery import build
          from google.oauth2.credentials import Credentials
          from googleapiclient.http import MediaFileUpload
          creds = Credentials(None, refresh_token=os.environ['TOK'], client_id=os.environ['ID'], client_secret=os.environ['SEC'], token_uri="https://oauth2.googleapis.com/token")
          youtube = build("youtube", "v3", credentials=creds)
          youtube.videos().insert(
            part="snippet,status", 
            body={"snippet": {"title": "Funny Animals Being Derps! ðŸ˜‚ #Shorts", "categoryId": "15"}, "status": {"privacyStatus": "public"}}, 
            media_body=MediaFileUpload("output.mp4", chunksize=-1, resumable=True)
          ).execute()

      - name: Upload Final Video (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: compiled-animal-video
          path: output.mp4
